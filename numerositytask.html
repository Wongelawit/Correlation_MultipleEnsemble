<!DOCTYPE html>
<html>
  <head>
    <link rel="icon" href="img/VCL_favicon.png">
    <title>Numerosity Task</title>

    <script src="jspsych-6.0.5/jspsych.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-image-keyboard-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-html-slider-response.js"></script>
    <script src="jspsych-6.0.5/plugins/jspsych-multiple-ensembles-grid.js"></script>
    <link href="jspsych-6.0.5/css/jspsych.css" rel="stylesheet" type="text/css"></link>

    <script src="scripts/subcondition_generator.js"></script>
    <script src="scripts/mask_generator.js"></script>

    <link rel="stylesheet" href="styles/styles.css">


  </head>
  <body>
  </body>
  <script>

    // INITIALIZE VARIABLES ================================================

    let timeline = [];

    // Extracts params from URL
    function getUrlVars() {
      var vars = {};
      var url = decodeURI(window.location.href);
      var parts = url.replace(/[?&]+([^=&]+)=([^&]*)/gi, function(m,key,value) {
          vars[key] = value;
      });
      return vars;
    }

    let params = getUrlVars();
    let color = params["color"];
    let is_short = params["short"];
    let subject_id = params["subjectID"];

    let one_pop_set = get_subcondition_set(color,1);
    let two_pop_set = get_subcondition_set(color, 2);

    let subconditions_first = [];
    let subconditions_second = [];

    let one_pop_first = (subject_id % 2 == 1);

    if (one_pop_first) {
        subconditions_first = one_pop_set.sort( () => Math.random() - 0.5);
        subconditions_second = two_pop_set.sort( () => Math.random() - 0.5);
    } else {
        subconditions_first = two_pop_set.sort( () => Math.random() - 0.5);
        subconditions_second = one_pop_set.sort( () => Math.random() - 0.5);
    }

    // ---------------------------------------------------------------------
    // WELCOME

    let welcome = {
      type: 'html-keyboard-response',
      stimulus: '<div align = "center">' + '<img src="img/VCL_lab_logo.png"></img> <br>' +
                'Welcome to the <b>Numerosity Task</b> Experiment.' +
                '<br><br><p><font size = 15>Press any key to begin.<p></font>' +
                '</div>',
      data: {type: 'instruction'}
    };
    timeline.push(welcome);

    // ---------------------------------------------------------------------
    // INSTRUCTIONS
    let targetname = subconditions_first[0]["target_path"];

    var height = window.innerheight/4;
    var width = height/2;

    let instructions1 = {
    type: "html-keyboard-response",
    stimulus: "<div align = 'center'>" + 
              "<p>You will fixate on the cross displayed in the center of the screen before each trial." + 
              "<p>Keep your attention there and watch for a display colored squares to appear." +
              "<p>Afterwards you will be asked to estimate how many of this square you saw." +
              "<div style='height: 100px; display: block;'>"+
              `<img style="height:100%"`+  "src='"+`${targetname}`+ "'></img>" +
              "</div>" + "<div> <p>Press any key to continue.</div>" + 
              "</div>"          
    };

    let instructions2 = {
        type: "html-keyboard-response",
        stimulus: "<div align = 'center'>" +
            "<p>You will fixate on the cross displayed in the center of the screen before each trial." +
            "<p>Keep your attention there and watch for a display of different colored squares to appear." +
            "<p>Afterwards you will be asked to estimate how many of ONLY this square you saw." +
            "<div style='height: 100px; display: block;'>"+
            `<img style="height:100%"`+  "src='"+`${targetname}`+ "'></img>" +
            "</div>" + "<div> <p>Press any key to continue.</div>" +
            "</div>"
    };

    let instructions_first;
    let instructions_second;

    if (one_pop_first) {
        instructions_first = instructions1;
        instructions_second = instructions2;
    } else {
        instructions_first = instructions2;
        instructions_second = instructions1;
    }

    timeline.push(instructions_first);

    // ---------------------------------------------------------------------
    // READY

    let ready = {
      type: 'html-keyboard-response',
      stimulus: "<div align = 'center'> <font size = 20><p>Ready? We will now begin the experiment. <p>" + "<br><br><p><b>Press any key to begin.</b></p></font></div>",
      data: {type: 'instruction'}
    };
    timeline.push(ready);

    // ---------------------------------------------------------------------
    // FIXATION

    let fixation = {
      type: 'html-keyboard-response',
      stimulus: '<div style="font-size:60px;">+</div>',
      choices: jsPsych.NO_KEYS,
      trial_duration: 1000,
      data: {type: 'fixation'}
    };

    // ---------------------------------------------------------------------
    // STIMULI

    // Randomize order

    // If want the shortened version, just slice out 5
    if (is_short === "true"){
      subconditions_first = subconditions_first.slice(0, 6);
      subconditions_second = subconditions_second.slice(0,6);
    }

    let count = 1;

    for (let subcondition of subconditions_first){

      stimuli = {
        type: 'multiple-ensembles-grid',
        choices: null,
        prompt: "</div></div><p>How many of this square do you see?" +
              "<div align = 'center' style='height: 25px; display: block;'>"+
              `<img style="height:100%"`+  "src='"+`${targetname}`+ "'></img>" +
              "</div>",
        trial_duration: 2000,
        distribution_sizes: [subcondition["target_size"],subcondition["distractor_size"]],
        stimuli: [subcondition["target_path"], subcondition["distractor_path"]],
        response_ends_trial: false,
      };

       masks = {
           type: 'html-slider-response',
           labels: [8,62],
           min: 8,
           max: 62,
           start: 35,
           stimulus: generate_stimulus(["stimuli/black.png","stimuli/white.png"], [50,50]),
           prompt: "<p>How many of this square did you see?" +
               "<div align = 'center' style='height: 25px; display: block;'>"+
               `<img style="height:100%"`+  "src='"+`${targetname}`+ "'></img>" +
               "</div><p>  </p>",
           on_start: function(trial) {
              trial.data = subcondition;
              trial.data.type = "test";
              trial.data.subject_id = subject_id;
              trial.data.trial = count;
              count++;
           }
        };

      timeline.push(fixation);
      timeline.push(stimuli);
      timeline.push(masks);
    }

    timeline.push(instructions_second);

    for (let subcondition of subconditions_second){

        stimuli = {
            type: 'multiple-ensembles-grid',
            choices: null,
            prompt: "</div></div><p>How many of this square do you see?" +
                "<div align = 'center' style='height: 25px; display: block;'>"+
                `<img style="height:100%"`+  "src='"+`${targetname}`+ "'></img>" +
                "</div>",
            trial_duration: 2000,
            distribution_sizes: [subcondition["target_size"],subcondition["distractor_size"]],
            stimuli: [subcondition["target_path"], subcondition["distractor_path"]],
            response_ends_trial: false,
        };

        masks = {
            type: 'html-slider-response',
            labels: [8,62],
            min: 8,
            max: 62,
            start: 35,
            prompt: "<p>How many of this square did you see?" +
                "<div align = 'center' style='height: 25px; display: block;'>"+
                `<img style="height:100%"`+  "src='"+`${targetname}`+ "'></img>" +
                "</div><p>  </p>",
            stimulus: generate_stimulus(["stimuli/black.png","stimuli/white.png"], [50,50]),
            on_start: function(trial) {
                trial.data = subcondition;
                trial.data.type = "test";
                trial.data.subject_id = subject_id;
                trial.data.trial = count;
                count++;
            }
        };

        timeline.push(fixation);
        timeline.push(stimuli);
        timeline.push(masks);
    }

    // ---------------------------------------------------------------------
    // INIT

    jsPsych.init({
      timeline: timeline,
      on_finish: function() {

        jsPsych.data.displayData();

        let trial_data = jsPsych.data.get()
                                .filter({type: 'test'})
                                .ignore('time_elapsed')
                                .ignore('internal_node_id')
                                .ignore('trial_type')
                                .ignore('trial_index')
                                .ignore('stimulus')
                                .ignore('target_path')
                                .ignore('distractor_path')
                                .ignore('type');

        let string = subject_id + "_numerosityTask.csv";
        trial_data.localSave('csv', string);
      }
    });

  </script>
  </html>